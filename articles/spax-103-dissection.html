<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>3. Under the Hood: Dissecting Spatial Accessibility Analysis ‚Ä¢ spax</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="3. Under the Hood: Dissecting Spatial Accessibility Analysis">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">spax</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/spax-101-intro.html">1. Getting Started with spax: A Healthcare Accessibility Case Study</a></li>
    <li><a class="dropdown-item" href="../articles/spax-102-data-prep.html">2. Preparing Data for Spatial Accessibility Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/spax-103-dissection.html">3. Under the Hood: Dissecting Spatial Accessibility Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/spax-104-raster-tradeoff.html">4. Why Rasters? The Pros, Cons, and Best Practices</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Songyosr/spax/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>3. Under the Hood: Dissecting Spatial Accessibility Analysis</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Songyosr/spax/blob/main/vignettes/spax-103-dissection.Rmd" class="external-link"><code>vignettes/spax-103-dissection.Rmd</code></a></small>
      <div class="d-none name"><code>spax-103-dissection.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="okay-time-for-some-theory">Okay, Time for Some Theory!<a class="anchor" aria-label="anchor" href="#okay-time-for-some-theory"></a>
</h2>
<p>We‚Äôve been avoiding this moment for two whole vignettes, but there‚Äôs
no escaping it anymore - we need to talk about theory. Don‚Äôt worry
though! Like any good recipe, spatial accessibility analysis is just a
matter of combining simple ingredients in the right way.</p>
<p>Let‚Äôs peek under the hood of spax to understand:</p>
<ul>
<li>How spatial accessibility is actually calculated</li>
<li>Why we chose certain approaches over others</li>
<li>How theory translates into actual code</li>
</ul>
<div class="section level3">
<h3 id="the-recipe-for-spatial-accessibility">The Recipe for Spatial Accessibility<a class="anchor" aria-label="anchor" href="#the-recipe-for-spatial-accessibility"></a>
</h3>
<p>At its heart, spatial accessibility tries to answer a deceptively
simple question: ‚ÄúHow easily can people reach the services they need?‚Äù
This involves three key ingredients:</p>
<ol style="list-style-type: decimal">
<li>People who need services (demand)</li>
<li>Places that provide services (supply)</li>
<li>The effort needed to connect them (distance/time)</li>
</ol>
<p>The Enhanced Two-Step Floating Catchment Area (E2SFCA) method, which
spax implements, combines these ingredients in two steps:</p>
<div class="section level4">
<h4 id="step-1-service-to-population-ratios">Step 1: Service-to-Population Ratios<a class="anchor" aria-label="anchor" href="#step-1-service-to-population-ratios"></a>
</h4>
<p>First, we calculate how much service capacity is available relative
to potential demand. For each service location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>j</mi></msub><mo>=</mo><mfrac><msub><mi>S</mi><mi>j</mi></msub><mrow><munder><mo>‚àë</mo><mi>i</mi></munder><msub><mi>P</mi><mi>i</mi></msub><msub><mi>W</mi><mi>d</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac></mrow><annotation encoding="application/x-tex">
R_j = \frac{S_j}{\sum_i P_i W_d(d_{ij})}
</annotation></semantics></math></p>
<p>Where:</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>S</mi><mi>j</mi></msub><annotation encoding="application/x-tex">S_j</annotation></semantics></math>is
the service capacity (like number of doctors)</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>P</mi><mi>i</mi></msub><annotation encoding="application/x-tex">P_i</annotation></semantics></math>
is the population at location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>d</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">W_d(d_{ij})</annotation></semantics></math>
is a weight based on travel time/distance</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>j</mi></msub><annotation encoding="application/x-tex">R_j</annotation></semantics></math>
is the resulting service-to-population ratio</li>
</ul>
<p>Think of this like calculating the ‚Äúdoctor-to-patient ratio‚Äù for each
hospital, but with a twist ‚Äì patients are weighted by how far they have
to travel.</p>
</div>
<div class="section level4">
<h4 id="step-2-accessibility-scores">Step 2: Accessibility Scores<a class="anchor" aria-label="anchor" href="#step-2-accessibility-scores"></a>
</h4>
<p>Then, we look at it from the population‚Äôs perspective. For each
location i:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>i</mi></msub><mo>=</mo><munder><mo>‚àë</mo><mi>j</mi></munder><msub><mi>R</mi><mi>j</mi></msub><msub><mi>W</mi><mi>r</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
A_i = \sum_j R_j W_r(d_{ij})
</annotation></semantics></math></p>
<p>Where:</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>j</mi></msub><annotation encoding="application/x-tex">R_j</annotation></semantics></math>
is the ratio we calculated in Step 1<br>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>r</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>d</mi><mi>_</mi><mrow><mi>i</mi><mi>j</mi></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">W_r(d\_{ij})</annotation></semantics></math>
is another distance-based weight<br>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>A</mi><mi>i</mi></msub><annotation encoding="application/x-tex">A_i</annotation></semantics></math>
is the final accessibility score</li>
</ul>
<p>This tells us how much service capacity people can reach, accounting
for both distance and competition from other users.</p>
</div>
</div>
<div class="section level3">
<h3 id="rasterized-formulas-a-different-perspective">Rasterized formulas: A Different Perspective<a class="anchor" aria-label="anchor" href="#rasterized-formulas-a-different-perspective"></a>
</h3>
<p>While these formulas are traditionally written in terms of points
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>,
our raster-based implementation thinks in terms of surfaces (~every
point
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
simultaneously). Let‚Äôs rewrite these equations to better reflect how
spax actually computes them:</p>
<div class="section level4">
<h4 id="step-1-service-to-population-ratios-raster-form">Step 1: Service-to-Population Ratios Raster Form<a class="anchor" aria-label="anchor" href="#step-1-service-to-population-ratios-raster-form"></a>
</h4>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>j</mi></msub><mo>=</mo><mfrac><msub><mi>s</mi><mi>j</mi></msub><mrow><mi>s</mi><mi>u</mi><mi>m</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>P</mi><mo>‚äô</mo><msub><mi>ùñ∂</mi><mi>ùñΩ</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>D</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac></mrow><annotation encoding="application/x-tex">
r_j = \frac{s_j}{sum(P \odot \mathsf{W_d}(D_j))}
</annotation></semantics></math></p>
<p>Where:</p>
<ul>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>P</mi><annotation encoding="application/x-tex">P</annotation></semantics></math>
is the population density surface</p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>D</mi><mi>j</mi></msub><annotation encoding="application/x-tex">D_j</annotation></semantics></math>
is the travel time/distance surface from facility
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math></p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ùñ∂</mi><mi>ùñΩ</mi></msub><annotation encoding="application/x-tex">\mathsf{W_d}</annotation></semantics></math>
is the demand-side weighting function</p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>‚äô</mo><annotation encoding="application/x-tex">\odot</annotation></semantics></math>
represents element-wise (Hadamard) multiplication</p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>m</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">sum()</annotation></semantics></math>
is the global sum over the entire surface</p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>s</mi><mi>j</mi></msub><annotation encoding="application/x-tex">s_j</annotation></semantics></math>
is the supply capacity at facility
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math></p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>r</mi><mi>j</mi></msub><annotation encoding="application/x-tex">r_j</annotation></semantics></math>
is the resulting ratio for facility
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math></p></li>
</ul>
</div>
<div class="section level4">
<h4 id="step-2-accessibility-scores---raster-form">Step 2: Accessibility Scores - Raster Form<a class="anchor" aria-label="anchor" href="#step-2-accessibility-scores---raster-form"></a>
</h4>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>=</mo><munder><mo>‚àë</mo><mi>j</mi></munder><msub><mi>r</mi><mi>j</mi></msub><msub><mi>ùñ∂</mi><mi>ùóã</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>D</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
A = \sum_j r_j \mathsf{W_r}(D_j)
</annotation></semantics></math></p>
<p>Where:</p>
<ul>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>
is now a complete accessibility surface rather than point-specific
values.</p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ùñ∂</mi><mi>ùóã</mi></msub><annotation encoding="application/x-tex">\mathsf{W_r}</annotation></semantics></math>
is the ratio-side weighting function</p></li>
</ul>
<p>This raster-based formulation:</p>
<ul>
<li>Eliminates the need to iterate over demand points
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
</li>
<li>Takes advantage of efficient matrix operations</li>
<li>Better reflects how <code>spax</code> works with continuous
surfaces</li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="from-formulas-to-functions">From Formulas to Functions<a class="anchor" aria-label="anchor" href="#from-formulas-to-functions"></a>
</h3>
<p>Let‚Äôs see how these formulas - both traditional and raster-based -
translate into actual code with spax:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/songyosr/spax" class="external-link">spax</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in get(paste0(generic, ".", class), envir = get_method_env()) : </span></span>
<span><span class="co">#&gt;   object 'type_sum.accel' not found</span></span>
<span></span>
<span><span class="co"># Load our example data</span></span>
<span><span class="va">pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">u5pd</span><span class="op">)</span> <span class="co"># Population density</span></span>
<span><span class="va">hospitals</span> <span class="op">&lt;-</span> <span class="va">hc12_hos</span> <span class="co"># Hospital locations</span></span>
<span><span class="va">distance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">hos_iscr</span><span class="op">)</span> <span class="co"># Travel times</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Let's look at the basic components for one hospital</span></span>
<span><span class="va">example_hospital</span> <span class="op">&lt;-</span> <span class="va">hospitals</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># Plot the fundamental surfaces</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Population surface (P)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pop</span>, main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"Population Surface"</span> <span class="op">~</span> <span class="op">(</span><span class="va">P</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Distance surface for facility j (D[j])</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">distance</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"Distance Surface"</span> <span class="op">~</span> <span class="op">(</span><span class="va">D</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Weighted surface (W[d](D[j]))</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/calc_decay.html">calc_decay</a></span><span class="op">(</span><span class="va">distance</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, method <span class="op">=</span> <span class="st">"gaussian"</span>, sigma <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>,</span>
<span>     main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"Weighted Surface"</span> <span class="op">~</span> <span class="op">(</span><span class="va">W</span><span class="op">[</span><span class="va">d</span><span class="op">]</span><span class="op">(</span><span class="va">D</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-103-dissection_files/figure-html/unnamed-chunk-2-1.png" width="800"></p>
<p>Each theoretical component becomes a raster operation:</p>
<ul>
<li>Population Surface
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>P</mi><annotation encoding="application/x-tex">P</annotation></semantics></math>):
A single raster showing population density/</li>
<li>Distance Surfaces
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>D</mi><mi>j</mi></msub><annotation encoding="application/x-tex">D_j</annotation></semantics></math>):
A stack of rasters, one per facility/</li>
<li>Weight Function
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ùñ∂</mi><mi>ùñΩ</mi></msub><mo>,</mo><msub><mi>ùñ∂</mi><mi>ùóã</mi></msub></mrow><annotation encoding="application/x-tex">\mathsf{W_d}, \mathsf{W_r}</annotation></semantics></math>):
Applied using <code><a href="../reference/calc_decay.html">calc_decay()</a></code>
</li>
</ul>
<p>The real power comes in how spax chains these operations together
efficiently. Rather than iterating over individual points, we: - Process
entire surfaces at once - Use optimized matrix operations - Take
advantage of parallel processing (via <code>terra</code>) where
possible</p>
</div>
</div>
<div class="section level2">
<h2 id="building-blocks-core-operations-in-spax">Building Blocks: Core Operations in spax<a class="anchor" aria-label="anchor" href="#building-blocks-core-operations-in-spax"></a>
</h2>
<div class="section level3">
<h3 id="distance-decay-from-theory-to-practice">Distance Decay: From Theory to Practice<a class="anchor" aria-label="anchor" href="#distance-decay-from-theory-to-practice"></a>
</h3>
<p>Now that we understand the theory, let‚Äôs look at how we actually
calculate those weight functions
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>d</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">W_d(d_{ij})</annotation></semantics></math>
or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ùñ∂</mi><mi>ùñΩ</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>D</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathsf{W_d}(D_j)</annotation></semantics></math>.
The weight function‚Äôs job is simple - take a distance value and return a
weight between 0 and 1. But how quickly should that weight decay with
distance?</p>
<p><code>spax</code> implements three classical decay functions (+ a
binary decay), each offering different mathematical properties. Let‚Äôs
align them at a common reference point (50% decay at 30 minutes) to see
how they behave:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create example data with functions aligned at 50% decay at 30 minutes</span></span>
<span><span class="va">example</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">160</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">example</span> <span class="op">&lt;-</span> <span class="va">example</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    gaussian_exp <span class="op">=</span> <span class="fu"><a href="../reference/calc_decay.html">calc_decay</a></span><span class="op">(</span><span class="va">x</span>, method <span class="op">=</span> <span class="st">"gaussian"</span>, sigma <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>,</span>
<span>    exponential_exp <span class="op">=</span> <span class="fu"><a href="../reference/calc_decay.html">calc_decay</a></span><span class="op">(</span><span class="va">x</span>, method <span class="op">=</span> <span class="st">"exponential"</span>, sigma <span class="op">=</span> <span class="fl">0.0196</span><span class="op">)</span>,</span>
<span>    power_exp <span class="op">=</span> <span class="fu"><a href="../reference/calc_decay.html">calc_decay</a></span><span class="op">(</span><span class="va">x</span>, method <span class="op">=</span> <span class="st">"power"</span>, sigma <span class="op">=</span> <span class="fl">0.1945</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">example</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">gaussian_exp</span>, color <span class="op">=</span> <span class="st">"Gaussian"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">exponential_exp</span>, color <span class="op">=</span> <span class="st">"Exponential"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">power_exp</span>, color <span class="op">=</span> <span class="st">"Power"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Distance Decay Functions"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"All functions aligned at 50% decay at 30 minutes"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Distance (minutes)"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Weight"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Function"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-103-dissection_files/figure-html/unnamed-chunk-3-1.png" width="800"></p>
<p>Each function offers a different mathematical perspective on how
distance affects accessibility:</p>
<ul>
<li>Gaussian decay
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>d</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msup><mi>e</mi><mrow><mo>‚àí</mo><msup><mi>d</mi><mn>2</mn></msup><mi>/</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><msup><mi>œÉ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup></mrow><annotation encoding="application/x-tex">W(d) = e^{-d^2/(2\sigma^2)}</annotation></semantics></math>):
Models accessibility like a bell curve, with the greatest change
happening around that 30-minute mark/</li>
<li>Exponential decay
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>d</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msup><mi>e</mi><mrow><mo>‚àí</mo><mi>Œª</mi><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W(d) = e^{-\lambda d}</annotation></semantics></math>):
Each additional minute of travel reduces accessibility by the same
percentage/</li>
<li>Power decay
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>d</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msup><mi>d</mi><mrow><mo>‚àí</mo><mi>Œ≤</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W(d) = d^{-\beta}</annotation></semantics></math>):
Similar to exponential early on, but maintains higher weights at larger
distances</li>
</ul>
<p>Let‚Äôs see how these functions transform our distance surfaces:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract one distance surface to explore</span></span>
<span><span class="va">D_j</span> <span class="op">&lt;-</span> <span class="va">distance</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="co"># Distance surface to our example hospital</span></span>
<span></span>
<span><span class="co"># Calculate weights using different decay functions</span></span>
<span><span class="va">gaussian_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_decay.html">calc_decay</a></span><span class="op">(</span><span class="va">D_j</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>  sigma <span class="op">=</span> <span class="fl">30</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">exponential_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_decay.html">calc_decay</a></span><span class="op">(</span><span class="va">D_j</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"exponential"</span>,</span>
<span>  sigma <span class="op">=</span> <span class="fl">0.0196</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">power_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_decay.html">calc_decay</a></span><span class="op">(</span><span class="va">D_j</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"power"</span>,</span>
<span>  sigma <span class="op">=</span> <span class="fl">0.1945</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize how different functions handle distance</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">D_j</span>, main <span class="op">=</span> <span class="st">"Original Distance Surface (D_j)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">gaussian_weights</span>, main <span class="op">=</span> <span class="st">"Gaussian Decay"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">exponential_weights</span>, main <span class="op">=</span> <span class="st">"Exponential Decay"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">power_weights</span>, main <span class="op">=</span> <span class="st">"Power Decay"</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-103-dissection_files/figure-html/unnamed-chunk-4-1.png" width="100%"></p>
<p>The beauty of spax‚Äôs raster-based approach is that these
transformations happen all at once - every cell in our distance surface
gets converted to a weight simultaneously. And because we‚Äôre using R‚Äôs
vectorized operations under the hood, this works just as efficiently
whether we‚Äôre looking at one facility or a hundred.</p>
<p>Want to create your own decay function? Any function that takes
distances and returns weights will work:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Custom decay combining distance threshold with Gaussian decay</span></span>
<span><span class="va">custom_decay</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">distance</span>, <span class="va">sigma</span> <span class="op">=</span> <span class="fl">30</span>, <span class="va">threshold</span> <span class="op">=</span> <span class="fl">40</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">gaussian</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">distance</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">sigma</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">gaussian</span><span class="op">[</span><span class="va">distance</span> <span class="op">&gt;</span> <span class="va">threshold</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>  <span class="co"># Hard cutoff at threshold</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">gaussian</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Use it just like the built-in functions</span></span>
<span><span class="va">custom_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_decay.html">calc_decay</a></span><span class="op">(</span><span class="va">D_j</span>, </span>
<span>  method <span class="op">=</span> <span class="va">custom_decay</span>, </span>
<span>  sigma <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  threshold <span class="op">=</span> <span class="fl">60</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">gaussian_weights</span>, main <span class="op">=</span> <span class="st">"Gaussian Decay"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">custom_weights</span>, main <span class="op">=</span> <span class="st">"Custom Decay\n(thresholded Gaussian)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-103-dissection_files/figure-html/unnamed-chunk-5-1.png" width="800"></p>
</div>
<div class="section level3">
<h3 id="managing-competition-weight-normalization">Managing Competition: Weight Normalization<a class="anchor" aria-label="anchor" href="#managing-competition-weight-normalization"></a>
</h3>
<p>Remember how we talked about counting patients in Step 1? Here‚Äôs
where things get tricky. If we don‚Äôt handle overlapping service areas
carefully, we might count the same population multiple times. This is
where <code><a href="../reference/calc_normalize.html">calc_normalize()</a></code> and <code><a href="../reference/calc_choice.html">calc_choice()</a></code> comes
in:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create weight surfaces for two nearby facilities</span></span>
<span><span class="va">W1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_decay.html">calc_decay</a></span><span class="op">(</span><span class="va">distance</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, method <span class="op">=</span> <span class="st">"gaussian"</span>, sigma <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="va">W2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_decay.html">calc_decay</a></span><span class="op">(</span><span class="va">distance</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, method <span class="op">=</span> <span class="st">"gaussian"</span>, sigma <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="va">facility_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">W1</span>, <span class="va">W2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare different normalization approaches</span></span>
<span><span class="va">standard_norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_normalize.html">calc_normalize</a></span><span class="op">(</span><span class="va">facility_weights</span>, method <span class="op">=</span> <span class="st">"standard"</span><span class="op">)</span></span>
<span><span class="va">semi_norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_normalize.html">calc_normalize</a></span><span class="op">(</span><span class="va">facility_weights</span>, method <span class="op">=</span> <span class="st">"semi"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize the effect of normalization</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">facility_weights</span><span class="op">)</span>, </span>
<span>     main <span class="op">=</span> <span class="st">"Raw Weight Sum\n(potential double-counting)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">standard_norm</span><span class="op">)</span>, </span>
<span>     main <span class="op">=</span> <span class="st">"Standard Normalization\n(sums to 1)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">semi_norm</span><span class="op">)</span>, </span>
<span>     main <span class="op">=</span> <span class="st">"Semi-normalization\n(prevents inflation)"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show where normalization matters most</span></span>
<span><span class="va">overlap_areas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">facility_weights</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">overlap_areas</span>, </span>
<span>     main <span class="op">=</span> <span class="st">"Competition Areas\n(where normalization matters)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-103-dissection_files/figure-html/unnamed-chunk-6-1.png" width="100%"></p>
<p>Think of normalization like adjusting a recipe when ingredients
overlap. If two hospitals serve the same area:</p>
<ul>
<li>Standard normalization: Forces weights to sum to 1, effectively
splitting demand between facilities</li>
<li>Semi-normalization: Only adjusts weights where facilities actually
compete (sum &gt; 1)</li>
<li>No normalization: Allows double-counting, which might be appropriate
for truly independent services</li>
</ul>
<p>In our raster formulation, this becomes a simple operation on
surfaces rather than complex point-wise calculations.</p>
</div>
<div class="section level3">
<h3 id="spreading-and-gathering-the-core-operations">Spreading and Gathering: The Core Operations<a class="anchor" aria-label="anchor" href="#spreading-and-gathering-the-core-operations"></a>
</h3>
<p>Now for the real workhorses of spax: the spread_weighted() and
gather_weighted() functions. These implement the summations in our
formulas:</p>
<ul>
<li><p>Traditional:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>‚àë</mo><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub><msub><mi>W</mi><mi>d</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\sum_i P_i W_d(d_{ij})</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>‚àë</mo><mi>j</mi></msub><msub><mi>R</mi><mi>j</mi></msub><msub><mi>W</mi><mi>r</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\sum_j R_j W_r(d_{ij})</annotation></semantics></math></p></li>
<li><p>Raster:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>m</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>P</mi><mo>‚äô</mo><msub><mi>ùñ∂</mi><mi>ùñΩ</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>D</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">sum(P \odot \mathsf{W_d}(D_j))</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>‚àë</mo><mi>j</mi></msub><msub><mi>r</mi><mi>j</mi></msub><msub><mi>ùñ∂</mi><mi>ùóã</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>D</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\sum_j r_j \mathsf{W_r}(D_j)</annotation></semantics></math></p></li>
</ul>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Let's see these operations in action</span></span>
<span><span class="co"># First, calculate potential demand for our facilities</span></span>
<span><span class="va">potential_demand</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gather_weighted.html">gather_weighted</a></span><span class="op">(</span></span>
<span>  <span class="va">pop</span>,           <span class="co"># Population surface (P)</span></span>
<span>  <span class="va">standard_norm</span>, <span class="co"># Normalized weights (W_d)</span></span>
<span>  simplify <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"Potential demand by facility:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Potential demand by facility:"</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">potential_demand</span><span class="op">)</span></span>
<span><span class="co">#&gt;   unit_id weighted_sum</span></span>
<span><span class="co">#&gt; 1    c172     151148.2</span></span>
<span><span class="co">#&gt; 2    c173     140127.4</span></span>
<span></span>
<span><span class="co"># Now calculate and spread accessibility</span></span>
<span><span class="va">supply_ratios</span> <span class="op">&lt;-</span> <span class="va">potential_demand</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    ratio <span class="op">=</span> <span class="va">hospitals</span><span class="op">$</span><span class="va">s_doc</span><span class="op">[</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">unit_id</span>, <span class="va">hospitals</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">]</span> <span class="op">/</span> <span class="va">weighted_sum</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"Supply ratios:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Supply ratios:"</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">supply_ratios</span><span class="op">)</span></span>
<span><span class="co">#&gt;   unit_id weighted_sum       ratio</span></span>
<span><span class="co">#&gt; 1    c172     151148.2 0.003453564</span></span>
<span><span class="co">#&gt; 2    c173     140127.4 0.002290772</span></span>
<span></span>
<span><span class="va">accessibility</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spread_weighted.html">spread_weighted</a></span><span class="op">(</span></span>
<span>  <span class="va">supply_ratios</span>,    <span class="co"># Facility-specific ratios (r_j)</span></span>
<span>  <span class="va">facility_weights</span>, <span class="co"># Weight surfaces (W_r)</span></span>
<span>  value_cols <span class="op">=</span> <span class="st">"ratio"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">accessibility</span>, main <span class="op">=</span> <span class="st">"Final Accessibility Surface (A)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">bound0</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-103-dissection_files/figure-html/unnamed-chunk-7-1.png" width="800"></p>
<p>Think of these operations as: - <code><a href="../reference/gather_weighted.html">gather_weighted()</a></code>:
Collects weighted values from a surface into facility-specific totals (a
vector) - <code><a href="../reference/spread_weighted.html">spread_weighted()</a></code>: Distributes facility-specific
values back across their service areas surface</p>
</div>
<div class="section level3">
<h3 id="putting-it-all-together">Putting It All Together<a class="anchor" aria-label="anchor" href="#putting-it-all-together"></a>
</h3>
</div>
<div class="section level3">
<h3 id="putting-it-all-together-1">Putting It All Together<a class="anchor" aria-label="anchor" href="#putting-it-all-together-1"></a>
</h3>
<p>Now that we understand each component, let‚Äôs see how
<code><a href="../reference/spax_e2sfca.html">spax_e2sfca()</a></code> orchestrates them into a complete
accessibility analysis. We‚Äôll follow both the formula and the actual
code:</p>
<div class="section level4">
<h4 id="the-complete-workflow">The Complete Workflow<a class="anchor" aria-label="anchor" href="#the-complete-workflow"></a>
</h4>
<table class="table">
<colgroup>
<col width="47%">
<col width="52%">
</colgroup>
<thead><tr class="header">
<th>Traditional</th>
<th>Raster</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><ol style="list-style-type: decimal">
<li>Calculate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>j</mi></msub><mo>=</mo><mfrac><msub><mi>S</mi><mi>j</mi></msub><mrow><msub><mo>‚àë</mo><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub><msub><mi>W</mi><mi>d</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac></mrow><annotation encoding="application/x-tex">R_j = \frac{S_j}{\sum_i P_i W_d(d_{ij})}</annotation></semantics></math>
for each facility</li>
</ol></td>
<td><ol style="list-style-type: decimal">
<li>Calculate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>j</mi></msub><mo>=</mo><mfrac><msub><mi>s</mi><mi>j</mi></msub><mrow><mi>s</mi><mi>u</mi><mi>m</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>P</mi><mo>‚äô</mo><msub><mi>ùñ∂</mi><mi>ùñΩ</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>D</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac></mrow><annotation encoding="application/x-tex">r_j = \frac{s_j}{sum(P \odot \mathsf{W_d}(D_j))}</annotation></semantics></math>
for each facility</li>
</ol></td>
</tr>
<tr class="even">
<td><ol start="2" style="list-style-type: decimal">
<li>Calculate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>i</mi></msub><mo>=</mo><msub><mo>‚àë</mo><mi>j</mi></msub><msub><mi>R</mi><mi>j</mi></msub><msub><mi>W</mi><mi>r</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">A_i = \sum_j R_j W_r(d_{ij})</annotation></semantics></math>
for each location</li>
</ol></td>
<td><ol start="2" style="list-style-type: decimal">
<li>Calculate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>=</mo><msub><mo>‚àë</mo><mi>j</mi></msub><msub><mi>r</mi><mi>j</mi></msub><msub><mi>ùñ∂</mi><mi>ùóã</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>D</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">A = \sum_j r_j \mathsf{W_r}(D_j)</annotation></semantics></math>
as a surface</li>
</ol></td>
</tr>
</tbody>
</table>
<p>Let‚Äôs see this step by step:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Step 1a: Create distance decay weights</span></span>
<span><span class="va">facility_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_decay.html">calc_decay</a></span><span class="op">(</span></span>
<span>  <span class="va">distance</span>,                    <span class="co"># Distance surfaces (D_j)</span></span>
<span>  method <span class="op">=</span> <span class="st">"gaussian"</span>, </span>
<span>  sigma <span class="op">=</span> <span class="fl">30</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 1b: Normalize weights to handle competition</span></span>
<span><span class="va">demand_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_normalize.html">calc_normalize</a></span><span class="op">(</span></span>
<span>  <span class="va">facility_weights</span>,           <span class="co"># W_d(D_j)</span></span>
<span>  method <span class="op">=</span> <span class="st">"standard"</span>        <span class="co"># Prevents double-counting</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 1c: Calculate potential demand for each facility</span></span>
<span><span class="va">potential_demand</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gather_weighted.html">gather_weighted</a></span><span class="op">(</span></span>
<span>  <span class="va">pop</span>,             <span class="co"># Population surface (P)</span></span>
<span>  <span class="va">demand_weights</span>,  <span class="co"># Normalized weights</span></span>
<span>  simplify <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 1d: Calculate supply-to-demand ratios</span></span>
<span><span class="va">supply_ratios</span> <span class="op">&lt;-</span> <span class="va">potential_demand</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    ratio <span class="op">=</span> <span class="va">hospitals</span><span class="op">$</span><span class="va">s_doc</span><span class="op">[</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">unit_id</span>, <span class="va">hospitals</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">]</span> <span class="op">/</span> <span class="va">weighted_sum</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 2: Calculate final accessibility surface</span></span>
<span><span class="va">accessibility</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spread_weighted.html">spread_weighted</a></span><span class="op">(</span></span>
<span>  <span class="va">supply_ratios</span>,     <span class="co"># Facility ratios (r_j)</span></span>
<span>  <span class="va">facility_weights</span>,  <span class="co"># Access-side weights (W_r)</span></span>
<span>  value_cols <span class="op">=</span> <span class="st">"ratio"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize the final result</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">accessibility</span>, main <span class="op">=</span> <span class="st">"E2SFCA Accessibility Surface"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">bound0</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-103-dissection_files/figure-html/unnamed-chunk-8-1.png" width="800"></p>
<p>Or we can let <code><a href="../reference/spax_e2sfca.html">spax_e2sfca()</a></code> handle all of this for
us:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The same calculation in one function call</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spax_e2sfca.html">spax_e2sfca</a></span><span class="op">(</span></span>
<span>  demand <span class="op">=</span> <span class="va">pop</span>,</span>
<span>  supply <span class="op">=</span> <span class="va">hospitals</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  distance <span class="op">=</span> <span class="va">distance</span>,</span>
<span>  decay_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"gaussian"</span>, sigma <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>,</span>
<span>  demand_normalize <span class="op">=</span> <span class="st">"standard"</span>,</span>
<span>  id_col <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  supply_cols <span class="op">=</span> <span class="st">"s_doc"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">result</span>, main <span class="op">=</span> <span class="st">"E2SFCA Accessibility Scores"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">bound0</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-103-dissection_files/figure-html/unnamed-chunk-9-1.png" width="800"></p>
</div>
<div class="section level4">
<h4 id="understanding-the-benefits">Understanding the Benefits<a class="anchor" aria-label="anchor" href="#understanding-the-benefits"></a>
</h4>
<p>This modular design offers several advantages:</p>
<ol style="list-style-type: decimal">
<li>
<p><strong>Flexibility</strong>: Each component can be
customized:</p>
<ul>
<li><p>Different decay functions</p></li>
<li><p>Alternative normalization approaches</p></li>
</ul>
</li>
<li>
<p><strong>Efficiency</strong>:</p>
<ul>
<li><p>Operations are vectorized across entire surfaces</p></li>
<li><p>Memory usage is optimized for large datasets</p></li>
<li><p>Parallel processing where beneficial</p></li>
</ul>
</li>
<li>
<p><strong>Transparency</strong>:</p>
<ul>
<li><p>Each step is clear and inspectable</p></li>
<li><p>Results can be validated at any stage</p></li>
<li><p>Intermediate outputs available for analysis</p></li>
</ul>
</li>
<li>
<p><strong>Extensibility</strong>:</p>
<ul>
<li><p>New components can be added easily</p></li>
<li><p>Custom workflows can be built from basic pieces</p></li>
<li><p>Alternative accessibility measures can be implemented</p></li>
</ul>
</li>
</ol>
</div>
</div>
<div class="section level3">
<h3 id="whats-next">What‚Äôs Next?<a class="anchor" aria-label="anchor" href="#whats-next"></a>
</h3>
<p>Now that you understand how spax works under the hood, you might want
to explore:</p>
<ul>
<li><p><a href="https://songyosr.github.io/spax/articles/spax-104-raster-tradeoff.html">Understanding
Raster Trade-offs</a>: Learn about the memory and performance
implications of our raster-based approach</p></li>
<li><p>Advanced Topics in Accessibility: Demand adjustment,
normalization, and choice-based modeling [Coming Soon]</p></li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Songyos Rajborirug.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
