<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>spax-103-dissection • spax</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="spax-103-dissection">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">spax</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/spax-101-intro.html">1. Getting Started with spax: A Healthcare Accessibility Case Study</a></li>
    <li><a class="dropdown-item" href="../articles/spax-102-data-prep.html">2. Preparing Data for Spatial Accessibility Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/spax-103-dissection.html">spax-103-dissection</a></li>
    <li><a class="dropdown-item" href="../articles/spax-104-raster-tradeoff.html">4. Tradeoffs: Understanding the Raster Approach in Spatial Accessibility Analysis</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/songyos/spax/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>spax-103-dissection</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/songyos/spax/blob/main/vignettes/spax-103-dissection.Rmd" class="external-link"><code>vignettes/spax-103-dissection.Rmd</code></a></small>
      <div class="d-none name"><code>spax-103-dissection.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="okay-time-for-some-theory">Okay, Time for Some Theory!<a class="anchor" aria-label="anchor" href="#okay-time-for-some-theory"></a>
</h2>
<p>We’ve been avoiding this moment for two whole vignettes, but there’s
no escaping it anymore - we need to talk about theory. Don’t worry
though! Like any good recipe, spatial accessibility analysis is just a
matter of combining simple ingredients in the right way.</p>
<p>Let’s peek under the hood of spax to understand:</p>
<ul>
<li>How spatial accessibility is actually calculated<br>
</li>
<li>Why we chose certain approaches over others<br>
</li>
<li>How theory translates into actual code</li>
</ul>
<div class="section level3">
<h3 id="the-recipe-for-spatial-accessibility">The Recipe for Spatial Accessibility<a class="anchor" aria-label="anchor" href="#the-recipe-for-spatial-accessibility"></a>
</h3>
<p>At its heart, spatial accessibility tries to answer a deceptively
simple question: “How easily can people reach the services they need?”
This involves three key ingredients:</p>
<ol style="list-style-type: decimal">
<li>People who need services (demand)</li>
<li>Places that provide services (supply)</li>
<li>The effort needed to connect them (distance/time)</li>
</ol>
<p>The Enhanced Two-Step Floating Catchment Area (E2SFCA) method, which
spax implements, combines these ingredients in two steps:</p>
<div class="section level4">
<h4 id="step-1-service-to-population-ratios">Step 1: Service-to-Population Ratios<a class="anchor" aria-label="anchor" href="#step-1-service-to-population-ratios"></a>
</h4>
<p>First, we calculate how much service capacity is available relative
to potential demand. For each service location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>j</mi></msub><mo>=</mo><mfrac><msub><mi>S</mi><mi>j</mi></msub><mrow><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>P</mi><mi>i</mi></msub><msub><mi>W</mi><mi>d</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac></mrow><annotation encoding="application/x-tex">
R_j = \frac{S_j}{\sum_i P_i W_d(d_{ij})}
</annotation></semantics></math></p>
<p>Where:</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>S</mi><mi>j</mi></msub><annotation encoding="application/x-tex">S_j</annotation></semantics></math>is
the service capacity (like number of doctors)</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>P</mi><mi>i</mi></msub><annotation encoding="application/x-tex">P_i</annotation></semantics></math>
is the population at location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>d</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">W_d(d_{ij})</annotation></semantics></math>
is a weight based on travel time/distance</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>j</mi></msub><annotation encoding="application/x-tex">R_j</annotation></semantics></math>
is the resulting service-to-population ratio</li>
</ul>
<p>Think of this like calculating the “doctor-to-patient ratio” for each
hospital, but with a twist – patients are weighted by how far they have
to travel.</p>
</div>
<div class="section level4">
<h4 id="step-2-accessibility-scores">Step 2: Accessibility Scores<a class="anchor" aria-label="anchor" href="#step-2-accessibility-scores"></a>
</h4>
<p>Then, we look at it from the population’s perspective. For each
location i:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>i</mi></msub><mo>=</mo><munder><mo>∑</mo><mi>j</mi></munder><msub><mi>R</mi><mi>j</mi></msub><msub><mi>W</mi><mi>r</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
A_i = \sum_j R_j W_r(d_{ij})
</annotation></semantics></math></p>
<p>Where:</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>j</mi></msub><annotation encoding="application/x-tex">R_j</annotation></semantics></math>
is the ratio we calculated in Step 1<br>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>r</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>d</mi><mi>_</mi><mrow><mi>i</mi><mi>j</mi></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">W_r(d\_{ij})</annotation></semantics></math>
is another distance-based weight<br>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>A</mi><mi>i</mi></msub><annotation encoding="application/x-tex">A_i</annotation></semantics></math>
is the final accessibility score</li>
</ul>
<p>This tells us how much service capacity people can reach, accounting
for both distance and competition from other users.</p>
</div>
</div>
<div class="section level3">
<h3 id="from-theory-to-rasters">From Theory to Rasters<a class="anchor" aria-label="anchor" href="#from-theory-to-rasters"></a>
</h3>
<p>Here’s where things get interesting. While the formula looks clean on
paper, implementing it efficiently means thinking in terms of raster
operations. Let’s see how spax breaks this down:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/songyos/spax" class="external-link">spax</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in get(paste0(generic, ".", class), envir = get_method_env()) : </span></span>
<span><span class="co">#&gt;   object 'type_sum.accel' not found</span></span>
<span></span>
<span><span class="co"># Load our example data</span></span>
<span><span class="va">pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">u5pd</span><span class="op">)</span> <span class="co"># Population density</span></span>
<span><span class="va">hospitals</span> <span class="op">&lt;-</span> <span class="va">hc12_hos</span> <span class="co"># Hospital locations</span></span>
<span><span class="va">distance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">hos_iscr</span><span class="op">)</span> <span class="co"># Travel times</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Let's look at one hospital's service area</span></span>
<span><span class="va">example_hospital</span> <span class="op">&lt;-</span> <span class="va">hospitals</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># Plot basic components</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pop</span>, main <span class="op">=</span> <span class="st">"Population\n(Demand)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">distance</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"Travel Time\n(Distance)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/calc_decay.html">calc_decay</a></span><span class="op">(</span><span class="va">distance</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, method <span class="op">=</span> <span class="st">"gaussian"</span>, sigma <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Distance Decay\n(Weight)"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-103-dissection_files/figure-html/unnamed-chunk-2-1.png" width="800"></p>
<p>Each theoretical component becomes a raster operation:</p>
<ul>
<li>Population
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>P</mi><mi>i</mi></msub><annotation encoding="application/x-tex">P_i</annotation></semantics></math>)
→ Population density raster<br>
</li>
<li>Distance
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">d_{ij}</annotation></semantics></math>)
→ Travel time raster<br>
</li>
<li>Weights
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>d</mi></msub><mo>,</mo><msub><mi>W</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">W_d, W_r</annotation></semantics></math>)
→ Decay function applied to distance</li>
</ul>
<p>The magic happens in how we combine these layers, but that’s getting
ahead of ourselves… Let’s look at each building block in detail.</p>
</div>
</div>
<div class="section level2">
<h2 id="building-blocks-from-theory-to-practice">Building Blocks: From Theory to Practice<a class="anchor" aria-label="anchor" href="#building-blocks-from-theory-to-practice"></a>
</h2>
<div class="section level3">
<h3 id="the-art-of-distance-decay">The Art of Distance Decay<a class="anchor" aria-label="anchor" href="#the-art-of-distance-decay"></a>
</h3>
<p>Let’s start with perhaps the most crucial building block: how we
model the effect of distance on accessibility. In theory, we write this
simply as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">W(d_{ij})</annotation></semantics></math>,
but in practice, we need to decide how exactly distance affects
accessibility.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Let's explore different decay functions</span></span>
<span><span class="va">distance_to_hospital</span> <span class="op">&lt;-</span> <span class="va">distance</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="co"># Travel time to our example hospital</span></span>
<span></span>
<span><span class="co"># Calculate weights using different decay functions</span></span>
<span><span class="va">gaussian_decay</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_decay.html">calc_decay</a></span><span class="op">(</span><span class="va">distance_to_hospital</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>  sigma <span class="op">=</span> <span class="fl">30</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">exponential_decay</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_decay.html">calc_decay</a></span><span class="op">(</span><span class="va">distance_to_hospital</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"exponential"</span>,</span>
<span>  sigma <span class="op">=</span> <span class="fl">0.05</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">power_decay</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_decay.html">calc_decay</a></span><span class="op">(</span><span class="va">distance_to_hospital</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"power"</span>,</span>
<span>  sigma <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize how different functions handle distance</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">distance_to_hospital</span>, main <span class="op">=</span> <span class="st">"Original Travel Time"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">gaussian_decay</span>, main <span class="op">=</span> <span class="st">"Gaussian Decay\n(smooth decline)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">exponential_decay</span>, main <span class="op">=</span> <span class="st">"Exponential Decay\n(steeper drop-off)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">power_decay</span>, main <span class="op">=</span> <span class="st">"Power Decay\n(long tail)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-103-dissection_files/figure-html/unnamed-chunk-3-1.png" width="800"></p>
<p>Each decay function tells a different story about how people interact
with distance:</p>
<ul>
<li>
<strong>Gaussian decay</strong>: Like a bell curve, suggesting
people are relatively willing to travel up to a certain distance before
their willingness drops off sharply<br>
</li>
<li>
<strong>Exponential decay</strong>: Assumes the deterrent effect of
distance increases steadily<br>
</li>
<li>
<strong>Power decay</strong>: Creates a long tail, good for services
where some users might travel very far</li>
</ul>
<p>And as we are dealing with raster data, any vectorized function can
be used as a decay function, and we will apply them across the entire
raster stack at the same time</p>
</div>
<div class="section level3">
<h3 id="managing-competition-weight-normalization">Managing Competition: Weight Normalization<a class="anchor" aria-label="anchor" href="#managing-competition-weight-normalization"></a>
</h3>
<p>Remember how we talked about counting patients in Step 1? Here’s
where things get tricky. If we don’t handle overlapping service areas
carefully, we might count the same population multiple times. This is
where <code><a href="../reference/calc_normalize.html">calc_normalize()</a></code> and <code><a href="../reference/calc_choice.html">calc_choice()</a></code> comes
in:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create example weights for two overlapping hospitals</span></span>
<span><span class="va">hospital_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="va">gaussian_decay</span>,</span>
<span>  <span class="fu"><a href="../reference/calc_decay.html">calc_decay</a></span><span class="op">(</span><span class="va">distance</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, method <span class="op">=</span> <span class="st">"gaussian"</span>, sigma <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Look at different normalization approaches</span></span>
<span><span class="va">standard_norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_normalize.html">calc_normalize</a></span><span class="op">(</span><span class="va">hospital_weights</span>, method <span class="op">=</span> <span class="st">"standard"</span><span class="op">)</span></span>
<span><span class="va">semi_norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_normalize.html">calc_normalize</a></span><span class="op">(</span><span class="va">hospital_weights</span>, method <span class="op">=</span> <span class="st">"semi"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize the effect of normalization</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">hospital_weights</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"Raw Weights\n(potential double-counting)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">standard_norm</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"Standard Normalization\n(always sums to 1)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">semi_norm</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"Semi-normalization\n(prevents inflation)"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add a plot showing where normalization matters most</span></span>
<span><span class="va">overlap_areas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">hospital_weights</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">overlap_areas</span>, main <span class="op">=</span> <span class="st">"Areas with Overlap\n(where normalization matters)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-103-dissection_files/figure-html/unnamed-chunk-4-1.png" width="800"></p>
<p>Think of normalization like adjusting a recipe when ingredients
overlap. If two hospitals serve the same area:</p>
<ul>
<li>Standard normalization splits the population evenly<br>
</li>
<li>Semi-normalization only adjusts in areas where multiple facilities
compete<br>
</li>
<li>No normalization might double-count, but could be appropriate for
truly independent services</li>
</ul>
</div>
<div class="section level3">
<h3 id="spreading-and-gathering-the-core-operations">Spreading and Gathering: The Core Operations<a class="anchor" aria-label="anchor" href="#spreading-and-gathering-the-core-operations"></a>
</h3>
<p>Now for the real magic – how do we actually implement those
theoretical summations? This is where <code><a href="../reference/spread_weighted.html">spread_weighted()</a></code> and
<code><a href="../reference/gather_weighted.html">gather_weighted()</a></code> come in. These functions are the
workhorses that handle the spatial distribution and aggregation of our
accessibility measures.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Let's see these operations in action</span></span>
<span><span class="co"># First, calculate potential demand for our hospitals</span></span>
<span><span class="va">potential_demand</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gather_weighted.html">gather_weighted</a></span><span class="op">(</span><span class="va">pop</span>,</span>
<span>  <span class="va">standard_norm</span>,</span>
<span>  simplify <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"Potential demand by facility:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Potential demand by facility:"</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">potential_demand</span><span class="op">)</span></span>
<span><span class="co">#&gt;   unit_id weighted_sum</span></span>
<span><span class="co">#&gt; 1    c172     151148.2</span></span>
<span><span class="co">#&gt; 2    c173     140127.4</span></span>
<span></span>
<span><span class="co"># Now calculate and spread supply ratios</span></span>
<span><span class="va">supply_ratios</span> <span class="op">&lt;-</span> <span class="va">potential_demand</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    ratio <span class="op">=</span> <span class="va">hospitals</span><span class="op">$</span><span class="va">s_doc</span><span class="op">[</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">unit_id</span>, <span class="va">hospitals</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">]</span> <span class="op">/</span> <span class="va">weighted_sum</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">accessibility</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spread_weighted.html">spread_weighted</a></span><span class="op">(</span><span class="va">supply_ratios</span>,</span>
<span>  <span class="va">hospital_weights</span>,</span>
<span>  value_cols <span class="op">=</span> <span class="st">"ratio"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">accessibility</span>, main <span class="op">=</span> <span class="st">"Final Accessibility Scores"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">bound0</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-103-dissection_files/figure-html/unnamed-chunk-5-1.png" width="800"></p>
<p>Think of <code><a href="../reference/gather_weighted.html">gather_weighted()</a></code> as a collector, summing up
weighted values (like population) across space. Meanwhile,
<code><a href="../reference/spread_weighted.html">spread_weighted()</a></code> works like a distributor, taking values
associated with facilities (like supply ratios) and spreading them
across their service areas.</p>
</div>
<div class="section level3">
<h3 id="putting-it-all-together">Putting It All Together<a class="anchor" aria-label="anchor" href="#putting-it-all-together"></a>
</h3>
<p>Now we can see how <code><a href="../reference/spax_e2sfca.html">spax_e2sfca()</a></code> orchestrates all these
components:</p>
<ol style="list-style-type: decimal">
<li>Creates distance decay weights using <code><a href="../reference/calc_decay.html">calc_decay()</a></code><br>
</li>
<li>Normalizes demand-side weights with
<code><a href="../reference/calc_normalize.html">calc_normalize()</a></code><br>
</li>
<li>Gathers potential demand using <code><a href="../reference/gather_weighted.html">gather_weighted()</a></code><br>
</li>
<li>Calculates supply ratios<br>
</li>
<li>Spreads accessibility scores using
<code><a href="../reference/spread_weighted.html">spread_weighted()</a></code>
</li>
</ol>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The full E2SFCA calculation we get "for free"</span></span>
<span><span class="va">full_accessibility</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spax_e2sfca.html">spax_e2sfca</a></span><span class="op">(</span></span>
<span>  demand <span class="op">=</span> <span class="va">pop</span>,</span>
<span>  supply <span class="op">=</span> <span class="va">hospitals</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  distance <span class="op">=</span> <span class="va">distance</span>,</span>
<span>  decay_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"gaussian"</span>, sigma <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>,</span>
<span>  demand_normalize <span class="op">=</span> <span class="st">"standard"</span>,</span>
<span>  id_col <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  supply_cols <span class="op">=</span> <span class="st">"s_doc"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">full_accessibility</span>, main <span class="op">=</span> <span class="st">"E2SFCA Accessibility Scores"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">bound0</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-103-dissection_files/figure-html/unnamed-chunk-6-1.png" width="800"></p>
<p>Understanding these building blocks not only helps you use
<strong>spax</strong> more effectively but also opens up possibilities
for customization. Want to try a custom decay function? Different
normalization approach? Novel accessibility measure? The modular design
lets you swap components while maintaining computational efficiency.</p>
<p>Next up: - <a href="https://songyosr.github.io/spax/articles/spax-104-raster-tradeoff.html">Understanding
Raster Trade-offs</a></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Songyos Rajborirug.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
