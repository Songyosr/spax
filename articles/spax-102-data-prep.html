<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>2. Preparing Data for Spatial Accessibility Analysis • spax</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="2. Preparing Data for Spatial Accessibility Analysis">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">spax</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/spax-101-intro.html">1. Getting Started with spax: A Healthcare Accessibility Case Study</a></li>
    <li><a class="dropdown-item" href="../articles/spax-102-data-prep.html">2. Preparing Data for Spatial Accessibility Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/spax-104-raster-tradeoff.html">4. Tradeoffs: Understanding the Raster Approach in Spatial Accessibility Analysis</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/songyos/spax/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>2. Preparing Data for Spatial Accessibility Analysis</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/songyos/spax/blob/main/vignettes/spax-102-data-prep.Rmd" class="external-link"><code>vignettes/spax-102-data-prep.Rmd</code></a></small>
      <div class="d-none name"><code>spax-102-data-prep.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load required packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/songyos/spax" class="external-link">spax</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in get(paste0(generic, ".", class), envir = get_method_env()) : </span></span>
<span><span class="co">#&gt;   object 'type_sum.accel' not found</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/riatelab/osrm" class="external-link">osrm</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="data-preparation-for-accessibility-analysis">Data Preparation for Accessibility Analysis<a class="anchor" aria-label="anchor" href="#data-preparation-for-accessibility-analysis"></a>
</h2>
<blockquote>
<p><em>“Give me six hours to chop down a tree, and I will spend the
first four sharpening the axe.”</em></p>
<p>— Abraham Lincoln(?)</p>
</blockquote>
<div class="section level3">
<h3 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h3>
<p>Spatial accessibility analysis requires three key components:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Demand</strong>: Population or service need
distribution</p></li>
<li><p><strong>Supply</strong>: Service locations and their
capacities</p></li>
<li><p><strong>Distance</strong>: Travel time or distance between demand
and supply</p></li>
</ol>
<p>This guide walks through preparing each component for use with
<code>spax</code>.</p>
</div>
<div class="section level3">
<h3 id="dealing-with-demand">Dealing with Demand<a class="anchor" aria-label="anchor" href="#dealing-with-demand"></a>
</h3>
<p>When preparing demand data for spatial accessibility analysis, we
have several approaches available, each with its own assumptions and
trade-offs. Let’s explore these methods using a simple example of
disease cases by province.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span> <span class="co"># For reproducibility</span></span>
<span></span>
<span><span class="co"># Example district-level case data</span></span>
<span><span class="va">case_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  ADM1_PCODE <span class="op">=</span> <span class="va">bound1</span><span class="op">$</span><span class="va">ADM1_PCODE</span>,</span>
<span>  cases <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">bound1</span><span class="op">)</span>, <span class="fl">1000</span>, <span class="fl">200</span><span class="op">)</span><span class="op">)</span> <span class="co"># Simulated disease cases</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Join with spatial data</span></span>
<span><span class="va">case_spatial</span> <span class="op">&lt;-</span> <span class="va">bound1</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">case_data</span>, by <span class="op">=</span> <span class="st">"ADM1_PCODE"</span><span class="op">)</span></span></code></pre></div>
<p>In a vector-based approach, we typically represent each area with a
polygon that has an attribute for the number of cases. This often
results in choropleth maps, like this:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot the case</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">bound1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">case_spatial</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">cases</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Cases by Province"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_b</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-102-data-prep_files/figure-html/unnamed-chunk-2-1.png" width="1200"></p>
<p>But that could sometimes be misleading since in traditional spatial
analysis, we often allocate demand to only the centroid of each
area:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate centroids and rasterize</span></span>
<span><span class="va">centroids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="va">case_spatial</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: st_centroid assumes attributes are constant over geometries</span></span>
<span></span>
<span><span class="co"># Plot the population data</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">bound1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">centroids</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">cases</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Population Data by Region"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-102-data-prep_files/figure-html/unnamed-chunk-3-1.png" width="1200"></p>
<p>The centroid approach works for vector-centric analysis, but for
<code>spax</code>, we need to think in terms of continuous surfaces.
Let’s explore different ways to convert our data</p>
<div class="section level4">
<h4 id="centroid-based-approach">1. Centroid-Based Approach<a class="anchor" aria-label="anchor" href="#centroid-based-approach"></a>
</h4>
<p>The simplest approach treats all demand as concentrated at area
centroids. This mirrors traditional vector-based accessibility analyses
but in raster format:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create template raster - Coarser resolution for example</span></span>
<span><span class="va">template</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">u5pd</span><span class="op">)</span>, fact <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rasterize centroids</span></span>
<span><span class="va">centroid_demand</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rasterize.html" class="external-link">rasterize</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">centroids</span><span class="op">)</span>,</span>
<span>  <span class="va">template</span>,</span>
<span>  field <span class="op">=</span> <span class="st">"cases"</span>,</span>
<span>  fun <span class="op">=</span> <span class="st">"sum"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">centroid_demand</span>, main <span class="op">=</span> <span class="st">"Centroid-Based Demand"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">bound1</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-102-data-prep_files/figure-html/unnamed-chunk-4-1.png" width="1200"></p>
<p>As you can see, this approach creates a somewhat odd-looking result -
all our demand is concentrated in single cells. However, this raster can
still be used in accessibility analysis, just like the original
population density raster. The key trade-off here is between simplicity
and spatial accuracy.</p>
</div>
<div class="section level4">
<h4 id="area-weighted-approach-developing">2. Area-Weighted Approach [developing]<a class="anchor" aria-label="anchor" href="#area-weighted-approach-developing"></a>
</h4>
<p>A more sophisticated method distributes cases evenly across each
province’s area:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Calculate case density</span></span>
<span><span class="va">case_spatial</span> <span class="op">&lt;-</span> <span class="va">case_spatial</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    area_m2 <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html" class="external-link">st_area</a></span><span class="op">(</span><span class="va">case_spatial</span><span class="op">)</span>, <span class="co"># estimate area</span></span>
<span>    case_density <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">cases</span> <span class="op">/</span> <span class="va">area_m2</span><span class="op">)</span> <span class="co"># calc density</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Rasterize case density</span></span>
<span><span class="va">case_density_raster</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rasterize.html" class="external-link">rasterize</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">case_spatial</span><span class="op">)</span>,</span>
<span>  <span class="va">template</span>,</span>
<span>  field <span class="op">=</span> <span class="st">"case_density"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Calculate pixel area in square kilometers</span></span>
<span><span class="va">pixel_area</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">res</a></span><span class="op">(</span><span class="va">template</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">res</a></span><span class="op">(</span><span class="va">template</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># 4. Convert density to absolute cases per pixel</span></span>
<span><span class="va">case_raster</span> <span class="op">&lt;-</span> <span class="va">case_density_raster</span> <span class="op">*</span> <span class="va">pixel_area</span></span></code></pre></div>
<p>Let’s see how this looks:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">case_raster</span>, main <span class="op">=</span> <span class="st">"Area-Weighted Demand"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">bound1</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-102-data-prep_files/figure-html/unnamed-chunk-6-1.png" width="1200"></p>
<p>This gives us a more continuous surface, but we should validate that
our totals still match:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract raster values for each polygon</span></span>
<span><span class="va">extracted_cases</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span></span>
<span>  <span class="va">case_raster</span>,</span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">case_spatial</span><span class="op">)</span>,</span>
<span>  fun <span class="op">=</span> <span class="va">sum</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare original vs rasterized totals</span></span>
<span><span class="va">case_spatial</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">ADM1_PCODE</span>, <span class="va">cases</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    raster_cases <span class="op">=</span> <span class="va">extracted_cases</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>    difference <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">cases</span> <span class="op">-</span> <span class="va">raster_cases</span><span class="op">)</span>,</span>
<span>    pct_diff <span class="op">=</span> <span class="op">(</span><span class="va">difference</span> <span class="op">/</span> <span class="va">cases</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="external-link">mutate_if</a></span><span class="op">(</span><span class="va">is.numeric</span>, <span class="va">round</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt;   ADM1_PCODE cases raster_cases difference pct_diff</span></span>
<span><span class="co">#&gt; 1       TH90  1274       1261.4       12.6      1.0</span></span>
<span><span class="co">#&gt; 2       TH91   887        867.4       19.6      2.2</span></span>
<span><span class="co">#&gt; 3       TH92  1073       1068.1        4.9      0.5</span></span>
<span><span class="co">#&gt; 4       TH93  1127       1131.1        4.1      0.4</span></span>
<span><span class="co">#&gt; 5       TH94  1081       1085.9        4.9      0.5</span></span>
<span><span class="co">#&gt; 6       TH95   979        995.2       16.2      1.7</span></span>
<span><span class="co">#&gt; 7       TH96  1302       1286.8       15.2      1.2</span></span></code></pre></div>
<p>The differences between original and rasterized values arise from the
discretization process. The results get closer as resolution increases,
but there’s always a trade-off between accuracy and computational
efficiency.</p>
</div>
<div class="section level4">
<h4 id="informed-distribution-developing">3. Informed Distribution [developing]<a class="anchor" aria-label="anchor" href="#informed-distribution-developing"></a>
</h4>
<p>Even more realistic distribution is possible using auxiliary data
like population density to inform where cases are likely to occur within
each province. <em>This section will be expanded in future
versions.</em></p>
</div>
<div class="section level4">
<h4 id="probabilistic-sampling-developing">4. Probabilistic Sampling [developing]<a class="anchor" aria-label="anchor" href="#probabilistic-sampling-developing"></a>
</h4>
<p>For uncertainty analysis, <code>spax</code> provides tools to
generate multiple potential demand distributions:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This advanced approach is covered in detail in the </span></span>
<span><span class="co"># "Probabilistic Accessibility Analysis" vignette </span></span>
<span><span class="op">?</span><span class="va">sample_pmf</span>  <span class="co"># See documentation for details</span></span></code></pre></div>
<p>The choice of demand preparation method can significantly impact your
accessibility analysis results. Consider your specific context:</p>
<ul>
<li>Data availability (Do you have population density data?)</li>
<li>Scale of analysis (Are districts large enough that distribution
matters?)</li>
<li>Purpose (Is point-based analysis sufficient for your needs?)</li>
<li>Computational resources (Can you handle higher resolution
distributions?)</li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="processing-supply-data">Processing Supply Data<a class="anchor" aria-label="anchor" href="#processing-supply-data"></a>
</h3>
<p>Supply data is usually the most straightforward component - we
typically know exactly where facilities are and their capacities.
However, these locations play a crucial role in the more complex task of
distance calculation that follows..</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Basic Supply Structure</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">hc12_hos</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">hoslvl</span>, <span class="va">s_doc</span>, <span class="va">s_nurse</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 6 features and 4 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 659422 ymin: 744135 xmax: 715990.7 ymax: 824148</span></span>
<span><span class="co">#&gt; Projected CRS: WGS 84 / UTM zone 47N</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 5</span></span></span>
<span><span class="co">#&gt;   id    hoslvl     s_doc s_nurse            geometry</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> c172  3-Regional   522     973 (662036.1 775836.7)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> c173  2-General    321     706   (672852 789753.3)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> c174  2-General     67      63     (659422 824148)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> c175  2-General     81     103     (692195 764766)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> c176  2-General    175     180   (687203.3 744135)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> c177  2-General     77     103 (715990.7 752559.6)</span></span></code></pre></div>
<p>For use in <code>spax</code>, supply data should be separated
into:</p>
<ol style="list-style-type: decimal">
<li>Spatial locations (for distance calculations)</li>
<li>Capacity attributes (for accessibility computations)</li>
</ol>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Separate spatial and attribute components</span></span>
<span><span class="va">supply_attributes</span> <span class="op">&lt;-</span> <span class="va">hc12_hos</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">s_doc</span>, <span class="va">s_nurse</span><span class="op">)</span> <span class="co"># Keep only relevant columns</span></span>
<span></span>
<span><span class="co"># Visual check of supply distribution</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">bound1</span>, fill <span class="op">=</span> <span class="st">"grey80"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">hc12_hos</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">s_doc</span>, color <span class="op">=</span> <span class="va">hoslvl</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_size.html" class="external-link">scale_size_continuous</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Number of Doctors"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_d</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Hospital Level"</span>, end <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Healthcare Supply Distribution"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Size indicates number of doctors, color shows facility level"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="spax-102-data-prep_files/figure-html/unnamed-chunk-10-1.png" width="1200"></p>
</div>
<div class="section level3">
<h3 id="creating-distancetravel-time-surfaces">Creating Distance/Travel Time Surfaces<a class="anchor" aria-label="anchor" href="#creating-distancetravel-time-surfaces"></a>
</h3>
<p>While supply locations themselves are straightforward, calculating
distances between supply and demand points is often the most complex
part of data preparation. Although it’s theoretically possible to
calculate distances from either supply to demand or demand to supply
(assuming travel times are symmetric), there are practical reasons why
we typically calculate from supply points:</p>
<ol style="list-style-type: decimal">
<li>We usually have fewer supply points than demand points, making
computation more efficient</li>
<li>When redistributing accessibility scores back to the population, we
need supply-based distances anyway</li>
</ol>
<p>Let’s explore different approaches to creating these distance
surfaces:</p>
<div class="section level5">
<h5 id="euclidean-distance">1. Euclidean Distance<a class="anchor" aria-label="anchor" href="#euclidean-distance"></a>
</h5>
<p>The simplest approach - straight-line distances:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example for one facility using terra</span></span>
<span><span class="va">facility_point</span> <span class="op">&lt;-</span> <span class="va">hc12_hos</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span><span class="va">template_rast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">u5pd</span><span class="op">)</span> <span class="co"># Use population raster as template</span></span>
<span></span>
<span><span class="co"># Calculate Euclidean distance (in meters since our CRS is projected)</span></span>
<span><span class="va">euclidean_dist</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/distance.html" class="external-link">distance</a></span><span class="op">(</span></span>
<span>  <span class="va">template_rast</span>,</span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">facility_point</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">bound0</span><span class="op">)</span>, mask <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; |---------|---------|---------|---------|=========================================                                          </span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot the Euclidean distance</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">euclidean_dist</span> <span class="op">/</span> <span class="fl">1000</span>, <span class="co"># Convert to kilometers</span></span>
<span>  main <span class="op">=</span> <span class="st">"Euclidean Distance (km)"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">facility_point</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, col <span class="op">=</span> <span class="st">"red"</span>, pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">bound0</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-102-data-prep_files/figure-html/unnamed-chunk-12-1.png" width="1200"></p>
<p>While simple, this approach ignores real-world travel constraints
like roads and barriers. It’s most useful for:</p>
<ul>
<li><p>Initial exploratory analysis</p></li>
<li><p>Areas with relatively uniform transportation networks</p></li>
<li><p>Services that aren’t strictly road-dependent</p></li>
</ul>
</div>
<div class="section level5">
<h5 id="travel-time-isochrones">2. Travel Time Isochrones<a class="anchor" aria-label="anchor" href="#travel-time-isochrones"></a>
</h5>
<p>A more realistic approach uses travel time isochrones - areas
reachable within specific time thresholds. While <code>spax</code>
doesn’t generate isochrones directly, we can use tools like the <a href="https://github.com/riatelab/osrm" class="external-link uri"><code>osrm</code></a> package:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example: Calculate isochrones for the first hospital</span></span>
<span><span class="co"># Since our data is in a planar projection, we need to transform it to WGS84 (EPSG:4326) for routing services</span></span>
<span></span>
<span><span class="va">example_hos1</span> <span class="op">&lt;-</span> <span class="va">hc12_hos</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span> <span class="op">|&gt;</span> <span class="co"># Select the first hospital</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># Transform to WGS84 (geodesic projection)</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># Extract coordinates</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># Convert to numeric</span></span>
<span></span>
<span><span class="co"># Calculate isochrones</span></span>
<span><span class="va">example_isochrone</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/osrm/man/osrmIsochrone.html" class="external-link">osrmIsochrone</a></span><span class="op">(</span></span>
<span>  loc <span class="op">=</span> <span class="va">example_hos1</span>, <span class="co"># Example coordinates</span></span>
<span>  breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">30</span>, <span class="fl">45</span>, <span class="fl">60</span><span class="op">)</span>, <span class="co"># 15-minute intervals</span></span>
<span>  res <span class="op">=</span> <span class="fl">30</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Transform back to our working CRS</span></span>
<span><span class="va">example_isochrone</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">example_isochrone</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">bound0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">example_isochrone</span><span class="op">[</span>, <span class="st">"isomax"</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"Travel Time Isochrone for Hospital C1"</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-102-data-prep_files/figure-html/unnamed-chunk-13-1.png" width="1200"></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">example_isochrone</span><span class="op">[</span><span class="fl">3</span>, <span class="st">"isomax"</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"Travel Time Isochrone ring for Hospital C1 (45 mins)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-102-data-prep_files/figure-html/unnamed-chunk-13-2.png" width="1200"></p>
<p>The isochrones show travel time “rings” around our facility. If you
take on a vector-based approach, you can use functions like <a href="https://r-spatial.github.io/sf/reference/st_contains.html" class="external-link"><code>sf::st_contains()</code></a>
to determine the population within each isochrone ring.</p>
<p>For <code>spax</code>, we need to convert these to a raster
format:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare isochrones for rasterization</span></span>
<span><span class="va">example_isochrone</span> <span class="op">&lt;-</span> <span class="va">example_isochrone</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    iso_mean <span class="op">=</span> <span class="op">(</span><span class="va">isomin</span> <span class="op">+</span> <span class="va">isomax</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>,</span>
<span>    location_id <span class="op">=</span> <span class="va">hc12_hos</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">$</span><span class="va">id</span> </span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert to raster format</span></span>
<span><span class="va">example_raster</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rasterize.html" class="external-link">rasterize</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">example_isochrone</span>,</span>
<span>  y <span class="op">=</span> <span class="va">template_rast</span>,</span>
<span>  field <span class="op">=</span> <span class="st">"iso_mean"</span>, <span class="co"># Fill the raster with the isomax values</span></span>
<span>  background <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  fun <span class="op">=</span> <span class="st">"sum"</span>,</span>
<span>  by <span class="op">=</span> <span class="st">"location_id"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">bound0</span><span class="op">)</span>, mask <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">example_raster</span>, main <span class="op">=</span> <span class="st">"Travel Time Isochrone for Hospital C1"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">bound0</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">hc12_hos</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, col <span class="op">=</span> <span class="st">"red"</span>, pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-102-data-prep_files/figure-html/unnamed-chunk-15-1.png" width="1200"></p>
<blockquote>
<p>⚠️ <strong>Important Note about OSRM</strong>: By default, the <a href="https://rdrr.io/cran/osrm/man/osrmIsochrone.html" class="external-link"><code>osrm::osrmIsochrone()</code></a>]
function uses OSRM’s demo server. This is fine for testing, but for real
analysis you should:</p>
<ul>
<li><p><a href="https://github.com/Project-OSRM/osrm-backend" class="external-link">Set up
your own OSRM server</a>. <em>This vignette does not cover the server
setup process.</em></p></li>
<li><p>Consider rate limits (demo server allows ~1
request/second)</p></li>
<li><p>Be mindful of server load and ethical usage</p></li>
</ul>
</blockquote>
<p>To process all facilities, you’d need to loop through them:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example code (not run due to API limitations)</span></span>
<span></span>
<span><span class="co"># Initialize a list to store isochrones</span></span>
<span><span class="va">isochrones</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">hc12_hos</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract coordinates</span></span>
<span><span class="va">hos_coords</span> <span class="op">&lt;-</span> <span class="va">hc12_hos</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># only if the data is in planar projection</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Loop over each hospital - lapply</span></span>
<span><span class="va">isochrones</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">hc12_hos</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Calculate isochrone</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/osrm/man/osrmIsochrone.html" class="external-link">osrmIsochrone</a></span><span class="op">(</span></span>
<span>    loc <span class="op">=</span> <span class="va">hos_coords</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">30</span>, <span class="fl">45</span>, <span class="fl">60</span><span class="op">)</span>,</span>
<span>    res <span class="op">=</span> <span class="fl">30</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co"># Then proceed to rastarization ...</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="service-provider-options">Service Provider Options<a class="anchor" aria-label="anchor" href="#service-provider-options"></a>
</h4>
<p>When creating travel time surfaces, you have several options:</p>
<p><strong>OSRM (Open Source Routing Machine)</strong></p>
<ul>
<li><label><input type="checkbox" checked>Free and open
source</label></li>
<li><label><input type="checkbox" checked>Can handle multiple
travel modes (if setup properly)</label></li>
<li>× Requires server setup for serious use</li>
<li>× Basic routing without traffic</li>
</ul>
<p><strong>Commercial APIs (HERE, Google Maps)</strong></p>
<ul>
<li><p><label><input type="checkbox" checked>Includes real-time
traffic</label></p></li>
<li><p><label><input type="checkbox" checked>More accurate travel
times</label></p></li>
<li><p>× Usage costs</p></li>
<li><p>× API limits</p></li>
</ul>
<p><strong>Custom cost surfaces</strong> (I have no idea how to do this,
lol)</p>
<ul>
<li><p><label><input type="checkbox" checked>Can include terrain,
land use</label></p></li>
<li><p><label><input type="checkbox" checked>Full control over
parameters</label></p></li>
<li><p>× Requires GIS expertise</p></li>
<li><p>× More complex to validate</p></li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="validating-your-data-essential-checks-before-analysis">Validating Your Data: Essential Checks Before Analysis<a class="anchor" aria-label="anchor" href="#validating-your-data-essential-checks-before-analysis"></a>
</h3>
<p>Before running any accessibility analysis, it’s crucial to validate
your prepared data. Here’s a systematic approach to validation (some of
which already implemented in the package:) :</p>
<div class="section level5">
<h5 id="spatial-alignment">1. Spatial Alignment<a class="anchor" aria-label="anchor" href="#spatial-alignment"></a>
</h5>
<p>All raster inputs must align perfectly - same extent, resolution, and
projection:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example:</span></span>
<span><span class="co"># You might want to create function to summarize raster properties</span></span>
<span><span class="va">summarize_raster</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">r</span>, <span class="va">name</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    Dataset <span class="op">=</span> <span class="va">name</span>,</span>
<span>    Resolution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">res</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">" x "</span><span class="op">)</span>,</span>
<span>    Extent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>,</span>
<span>    CRS <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">r</span>, proj <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Compare properties of key rasters</span></span>
<span><span class="va">raster_props</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="fu">summarize_raster</span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">u5pd</span><span class="op">)</span>, <span class="st">"Population"</span><span class="op">)</span>,</span>
<span>  <span class="fu">summarize_raster</span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">hos_iscr</span><span class="op">)</span>, <span class="st">"Travel Time"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">raster_props</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 4</span></span></span>
<span><span class="co">#&gt;   Dataset     Resolution    Extent                                     CRS      </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                                      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Population  520.4 x 520.4 505646.53, 842347.77, 620843.72, 885729.24 +proj=ut…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Travel Time 520.4 x 520.4 505646.53, 842347.77, 620843.72, 885729.24 +proj=ut…</span></span>
<span></span>
<span><span class="co"># Visual check for alignment</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">u5pd</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"Spatial Alignment Check"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">hos_iscr</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">bound1</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="spax-102-data-prep_files/figure-html/unnamed-chunk-17-1.png" width="1200"></p>
</div>
<div class="section level5">
<h5 id="value-range-validation">2. Value Range Validation<a class="anchor" aria-label="anchor" href="#value-range-validation"></a>
</h5>
<p>Check for reasonable values in your input data:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check population density range</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">u5pd</span><span class="op">)</span></span>
<span><span class="co">#&gt;         tha_children_under_five_2020</span></span>
<span><span class="co">#&gt; Min.                    0.000000e+00</span></span>
<span><span class="co">#&gt; 1st Qu.                 1.385807e+00</span></span>
<span><span class="co">#&gt; Median                  3.497750e+00</span></span>
<span><span class="co">#&gt; 3rd Qu.                 7.571418e+00</span></span>
<span><span class="co">#&gt; Max.                    8.307421e+01</span></span>
<span><span class="co">#&gt; NA's                    2.781020e+05</span></span>
<span></span>
<span><span class="co"># Check a few travel time rasters</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">hos_iscr</span><span class="op">[[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="co">#&gt; Warning in .local(object, ...): summary is an estimate based on a sample of 1e+05 cells (30.37% of all cells)</span></span>
<span><span class="co">#&gt;             c172     c173     c174     c175     c176     c177     c178     c179</span></span>
<span><span class="co">#&gt; Min.         6.0      3.0      3.5      4.0      8.5     11.0      5.0      7.5</span></span>
<span><span class="co">#&gt; 1st Qu.     67.5     67.5     82.5     67.5     67.5     67.5     67.5     97.5</span></span>
<span><span class="co">#&gt; Median      97.5    112.5    127.5    112.5    112.5    112.5    112.5    127.5</span></span>
<span><span class="co">#&gt; 3rd Qu.    142.5    142.5    157.5    142.5    142.5    142.5    157.5    157.5</span></span>
<span><span class="co">#&gt; Max.       172.5    172.5    172.5    172.5    172.5    172.5    172.5    172.5</span></span>
<span><span class="co">#&gt; NA's    232772.0 232555.0 241578.0 226680.0 231076.0 235489.0 241789.0 246926.0</span></span>
<span><span class="co">#&gt;             c180     c181</span></span>
<span><span class="co">#&gt; Min.         5.0      8.5</span></span>
<span><span class="co">#&gt; 1st Qu.     97.5     67.5</span></span>
<span><span class="co">#&gt; Median     127.5     97.5</span></span>
<span><span class="co">#&gt; 3rd Qu.    157.5    127.5</span></span>
<span><span class="co">#&gt; Max.       172.5    172.5</span></span>
<span><span class="co">#&gt; NA's    247713.0 236889.0</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="missing-value-analysis">3. Missing Value Analysis<a class="anchor" aria-label="anchor" href="#missing-value-analysis"></a>
</h5>
<p>Understand where and why you have NA values; note that not all NAs
are bad:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function to analyze NA patterns within boundary</span></span>
<span><span class="co"># PS. Will be implemented in the package later</span></span>
<span><span class="va">analyze_nas</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">r</span>, <span class="va">name</span>, <span class="va">bound</span> <span class="op">=</span> <span class="va">bound0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create mask from boundary</span></span>
<span>  <span class="va">mask</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rasterize.html" class="external-link">rasterize</a></span><span class="op">(</span><span class="va">bound</span>, <span class="va">r</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Count cells only within boundary</span></span>
<span>  <span class="va">cells_in_boundary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/global.html" class="external-link">global</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">mask</span><span class="op">)</span>, <span class="st">"sum"</span><span class="op">)</span><span class="op">$</span><span class="va">sum</span></span>
<span>  <span class="va">nas_in_boundary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/global.html" class="external-link">global</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">mask</span><span class="op">)</span>, <span class="st">"sum"</span><span class="op">)</span><span class="op">$</span><span class="va">sum</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s:\n"</span>, <span class="va">name</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>      <span class="st">"  NA cells within boundary: %d (%.1f%% of study area)\n"</span>,</span>
<span>      <span class="va">nas_in_boundary</span>,</span>
<span>      <span class="fl">100</span> <span class="op">*</span> <span class="va">nas_in_boundary</span> <span class="op">/</span> <span class="va">cells_in_boundary</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Visualize NA pattern</span></span>
<span>  <span class="va">na_map</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">mask</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">bound</span>, mask <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">na_map</span>,</span>
<span>    main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">name</span>, <span class="st">"- NAs within Study Area"</span><span class="op">)</span>,</span>
<span>    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"grey80"</span>, <span class="st">"red"</span><span class="op">)</span>,</span>
<span>    legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">bound1</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"bottomright"</span>,</span>
<span>    legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Data present"</span>, <span class="st">"NA"</span><span class="op">)</span>,</span>
<span>    fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"grey80"</span>, <span class="st">"red"</span><span class="op">)</span>,</span>
<span>    bty <span class="op">=</span> <span class="st">"n"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Check NA patterns in key datasets</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">analyze_nas</span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">u5pd</span><span class="op">)</span>, <span class="st">"Pop"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Pop:</span></span>
<span><span class="co">#&gt;    NA cells within boundary: 60551 (54.4% of study area)</span></span>
<span><span class="fu">analyze_nas</span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">hos_iscr</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="st">"Time from 1st Fac"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Time from 1st Fac:</span></span>
<span><span class="co">#&gt;    NA cells within boundary: 16841 (15.1% of study area)</span></span></code></pre></div>
<p><img src="spax-102-data-prep_files/figure-html/unnamed-chunk-19-1.png" width="1200"></p>
</div>
<div class="section level4">
<h4 id="final-reminders">Final reminders:<a class="anchor" aria-label="anchor" href="#final-reminders"></a>
</h4>
<ol style="list-style-type: decimal">
<li>
<p><strong>Resolution Selection</strong></p>
<ul>
<li>Higher resolution ≠ better analysis</li>
<li>Consider computational resources</li>
<li>Match resolution to spatial scale of research question</li>
</ul>
</li>
<li>
<p><strong>Coordinate Reference Systems</strong></p>
<ul>
<li>Be consistent with CRS across all datasets</li>
<li>Document CRS choices and transformations</li>
<li>Consider distortion implications</li>
</ul>
</li>
<li>
<p><strong>Documentation</strong></p>
<ul>
<li><p>Note data sources and dates</p></li>
<li><p>Document all preprocessing steps</p></li>
<li><p>Record assumptions made</p></li>
<li><p>Note known limitations</p></li>
</ul>
</li>
</ol>
</div>
</div>
<div class="section level3">
<h3 id="next-steps">Next Steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h3>
<p>With your data prepared, you’re ready to move on to actual
accessibility analysis. You can explore the following resources for more
information:</p>
<ul>
<li>Dissecting spax: Understanding the package’s inner workings
<em>[under development]</em>
</li>
<li><a href="https://songyosr.github.io/spax/articles/spax-104-raster-tradeoff.html">Understanding
Raster Trade-offs</a></li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Songyos Rajborirug.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
